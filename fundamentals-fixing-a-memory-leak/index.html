



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
        <meta name="description" content="A memory leak detection library for Android">
      
      
        <link rel="canonical" href="https://square.github.io/leakcanary/fundamentals-fixing-a-memory-leak/">
      
      
        <meta name="author" content="Square, Inc.">
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../images/logo.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.6.0">
    
    
      
        <title>Fixing a memory leak - LeakCanary</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.1b62728e.css">
      
        <link rel="stylesheet" href="../assets/stylesheets/application-palette.a8b3c06d.css">
      
      
        
        
        <meta name="theme-color" content="#ff7043">
      
    
    
      <script src="../assets/javascripts/modernizr.268332fc.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
    
    
      
        
<script>
  window.ga = window.ga || function() {
    (ga.q = ga.q || []).push(arguments)
  }
  ga.l = +new Date
  /* Setup integration and send page view */
  ga("create", "None", "auto")
  ga("set", "anonymizeIp", true)
  ga("send", "pageview")
  /* Register handler to log search on blur */
  document.addEventListener("DOMContentLoaded", () => {
    if (document.forms.search) {
      var query = document.forms.search.query
      query.addEventListener("blur", function() {
        if (this.value) {
          var path = document.location.pathname;
          ga("send", "pageview", path + "?q=" + this.value)
        }
      })
    }
  })
</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
      
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="deep-orange" data-md-color-accent="deep-purple">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#1-find-the-leak-trace" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="https://square.github.io/leakcanary/" title="LeakCanary" class="md-header-nav__button md-logo">
          
            <img src="../images/logo.png" width="24" height="24">
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              LeakCanary
            </span>
            <span class="md-header-nav__topic">
              
                Fixing a memory leak
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="https://github.com/square/leakcanary/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    LeakCanary
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
        

  

<nav class="md-tabs md-tabs--active" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  <li class="md-tabs__item">
    
      <a href=".." class="md-tabs__link">
        Overview
      </a>
    
  </li>

      
        
      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../fundamentals/" class="md-tabs__link md-tabs__link--active">
          Fundamentals
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../recipes/" class="md-tabs__link">
          Help & Community
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../shark/" class="md-tabs__link">
          Shark
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../api/leakcanary-android-core/leakcanary/" class="md-tabs__link">
          LeakCanary API
        </a>
      
    </li>
  

      
        
      
    </ul>
  </div>
</nav>
      
      <main class="md-main" role="main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="https://square.github.io/leakcanary/" title="LeakCanary" class="md-nav__button md-logo">
      
        <img src="../images/logo.png" width="48" height="48">
      
    </a>
    LeakCanary
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/square/leakcanary/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    LeakCanary
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../getting_started/" title="Getting Started" class="md-nav__link">
      Getting Started
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3" checked>
    
    <label class="md-nav__link" for="nav-3">
      Fundamentals
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Fundamentals
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../fundamentals/" title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../fundamentals-how-leakcanary-works/" title="How LeakCanary works" class="md-nav__link">
      How LeakCanary works
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Fixing a memory leak
      </label>
    
    <a href="./" title="Fixing a memory leak" class="md-nav__link md-nav__link--active">
      Fixing a memory leak
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-find-the-leak-trace" class="md-nav__link">
    1. Find the leak trace
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-narrow-down-the-leak-trace" class="md-nav__link">
    2. Narrow down the leak trace
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-find-the-cause" class="md-nav__link">
    3. Find the cause
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-fix-the-leak" class="md-nav__link">
    4. Fix the leak
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      Help & Community
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        Help & Community
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../recipes/" title="Code recipes" class="md-nav__link">
      Code recipes
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../faq/" title="FAQ" class="md-nav__link">
      FAQ
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../support/" title="Support" class="md-nav__link">
      Support
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../upgrading-to-leakcanary-2.0/" title="Upgrading to LeakCanary 2" class="md-nav__link">
      Upgrading to LeakCanary 2
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../recorded-presentations/" title="Recorded Presentations" class="md-nav__link">
      Recorded Presentations
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../blog-articles/" title="Blog Articles" class="md-nav__link">
      Blog Articles
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="https://stackoverflow.com/questions/tagged/leakcanary?sort=active" title="Stack Overflow ‚èè" class="md-nav__link">
      Stack Overflow ‚èè
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4-8" type="checkbox" id="nav-4-8">
    
    <label class="md-nav__link" for="nav-4-8">
      Contributing
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-4-8">
        Contributing
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../how_to_help/" title="How to help" class="md-nav__link">
      How to help
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../code_of_conduct/" title="Code of Conduct" class="md-nav__link">
      Code of Conduct
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../dev-env/" title="Dev Environment" class="md-nav__link">
      Dev Environment
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../releasing/" title="Releasing" class="md-nav__link">
      Releasing
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      Shark
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        Shark
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../shark/" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-2" type="checkbox" id="nav-5-2">
    
    <label class="md-nav__link" for="nav-5-2">
      Shark API
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-5-2">
        Shark API
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../api/shark/shark/" title="Shark" class="md-nav__link">
      Shark
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../api/shark-android/shark/" title="Extension: Shark Android" class="md-nav__link">
      Extension: Shark Android
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../api/shark-graph/shark/" title="Core: Graph" class="md-nav__link">
      Core: Graph
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../api/shark-hprof/shark/" title="Core: Hprof" class="md-nav__link">
      Core: Hprof
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../api/shark-log/shark/" title="Core: Logs" class="md-nav__link">
      Core: Logs
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6">
    
    <label class="md-nav__link" for="nav-6">
      LeakCanary API
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        LeakCanary API
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../api/leakcanary-android-core/leakcanary/" title="LeakCanary" class="md-nav__link">
      LeakCanary
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../api/leakcanary-object-watcher-android/leakcanary/" title="ObjectWatcher Android" class="md-nav__link">
      ObjectWatcher Android
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../api/leakcanary-android-instrumentation/leakcanary/" title="Extension: Instrumentation tests" class="md-nav__link">
      Extension: Instrumentation tests
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../api/leakcanary-android-process/leakcanary/" title="Extension: Separate process" class="md-nav__link">
      Extension: Separate process
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../api/leakcanary-object-watcher/leakcanary/" title="Core: ObjectWatcher" class="md-nav__link">
      Core: ObjectWatcher
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../changelog/" title="Change Log" class="md-nav__link">
      Change Log
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-find-the-leak-trace" class="md-nav__link">
    1. Find the leak trace
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-narrow-down-the-leak-trace" class="md-nav__link">
    2. Narrow down the leak trace
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-find-the-cause" class="md-nav__link">
    3. Find the cause
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-fix-the-leak" class="md-nav__link">
    4. Fix the leak
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
				  
				<span style="float: right">ü§î Documentation issue? <a href="https://github.com/square/leakcanary/issues/new?assignees=&labels=type%3A+documentation&template=4-doc.md&title=Doc%20issue%20with%20fundamentals-fixing-a-memory-leak/%20page">Report</a> or <a href="https://github.com/square/leakcanary/edit/master/docs/fundamentals-fixing-a-memory-leak.md">edit</a></span>
                  
                
                
                  <h1>Fixing a memory leak</h1>
                
                <p>A memory leak is a programming error that causes an application to keep a reference to an object that is no longer needed. Somewhere in the code, there&rsquo;s a reference that should have been cleared and wasn&rsquo;t.</p>
<p>There are 4 steps to fixing a memory leak:</p>
<ol>
<li>Find the leak trace</li>
<li>Narrow down the leak trace</li>
<li>Find the cause</li>
<li>Fix the leak</li>
</ol>
<p>LeakCanary helps you with the first two steps. The last two steps are up to you!</p>
<h2 id="1-find-the-leak-trace">1. Find the leak trace<a class="headerlink" href="#1-find-the-leak-trace" title="Permanent link">&para;</a></h2>
<p>A <strong>leak trace</strong> is the <em>best strong reference path from garbage collection roots to the retained object</em>, ie the path of references that is holding an object in memory, therefore preventing it from being garbage collected.</p>
<p>For example, if we store a helper singleton in a static field:</p>
<div class="codehilite"><pre><span></span><span class="kd">class</span> <span class="nc">Helper</span> <span class="p">{</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">Utils</span> <span class="p">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="n">Helper</span> <span class="n">helper</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Helper</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>

<p>And then we tell LeakCanary that we expect that singleton instance to be garbage collected soon:</p>
<div class="codehilite"><pre><span></span>AppWatcher.objectWatcher.watch(Utils.helper)
</pre></div>

<p>The leak trace for that singleton could look like this:</p>
<div class="codehilite"><pre><span></span>‚î¨‚îÄ‚îÄ‚îÄ
‚îÇ GC Root: Local variable in native code
‚îÇ
‚îú‚îÄ dalvik.system.PathClassLoader instance
‚îÇ    ‚Üì PathClassLoader.runtimeInternalObjects
‚îú‚îÄ java.lang.Object[] array
‚îÇ    ‚Üì Object[].[43]
‚îú‚îÄ com.example.Utils class
‚îÇ    ‚Üì static Utils.helper
‚ï∞‚Üí java.example.Helper
</pre></div>

<p>Let&rsquo;s break it down! At the top, we can see that a <code>PathClassLoader</code> instance is held by a garbage collection (GC) root, more specifically a local variable in native code. GC roots are special objects that are always reachable, ie they cannot be garbage collected. There are four kinds of GC roots worth mentioning:</p>
<ul>
<li><strong>Local variables</strong>, which belong to the stack of a thread.</li>
<li>Instances of <strong>active Java threads</strong>.</li>
<li><strong>System Classes</strong>, which never unload.</li>
<li><strong>Native references</strong>, which are controlled by native code.</li>
</ul>
<div class="codehilite"><pre><span></span>‚î¨‚îÄ‚îÄ‚îÄ
‚îÇ GC Root: Local variable in native code
‚îÇ
‚îú‚îÄ dalvik.system.PathClassLoader instance
</pre></div>

<p>A line starting with <code>‚îú‚îÄ</code> represents a Java object (either a class, an object array or an instance), and a line starting with <code>‚îÇ    ‚Üì</code> represents a reference to the Java object on the next line.</p>
<p>We can see that <code>PathClassLoader</code> has a <code>runtimeInternalObjects</code> field which is a reference to an array of <code>Object</code>. </p>
<div class="codehilite"><pre><span></span>‚îú‚îÄ dalvik.system.PathClassLoader instance
‚îÇ    ‚Üì PathClassLoader.runtimeInternalObjects
‚îú‚îÄ java.lang.Object[] array
</pre></div>

<p>The element at position 43 in that array of <code>Object</code> is a reference to our <code>Utils</code> class.</p>
<div class="codehilite"><pre><span></span>‚îú‚îÄ java.lang.Object[] array
‚îÇ    ‚Üì Object[].[43]
‚îú‚îÄ com.example.Utils class
</pre></div>

<p>A line starting with <code>‚ï∞‚Üí</code> represents the leaking object. The leaking object was passed to <a href="/leakcanary/api/leakcanary-object-watcher-android/leakcanary/-app-watcher/object-watcher/">AppWatcher.objectWatcher</a> to confirm it would be garbage collected, and it ended up not being garbage collected which triggered LeakCanary.</p>
<p>We can see that our <code>Utils</code> class has a static <code>helper</code> field which is a reference to the leaking object, our Helper singleton instance. </p>
<div class="codehilite"><pre><span></span>‚îú‚îÄ com.example.Utils class
‚îÇ    ‚Üì static Utils.helper
‚ï∞‚Üí java.example.Helper instance
</pre></div>

<h2 id="2-narrow-down-the-leak-trace">2. Narrow down the leak trace<a class="headerlink" href="#2-narrow-down-the-leak-trace" title="Permanent link">&para;</a></h2>
<p>Now, let&rsquo;s write some bad Android code:</p>
<div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">ExampleApplication</span> <span class="p">:</span> <span class="n">Application</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">val</span> <span class="py">leakedViews</span> <span class="p">=</span> <span class="n">mutableListOf</span><span class="p">&lt;</span><span class="n">View</span><span class="p">&gt;()</span>
<span class="p">}</span>

<span class="k">class</span> <span class="nc">MainActivity</span> <span class="p">:</span> <span class="n">Activity</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">override</span> <span class="k">fun</span> <span class="nf">onCreate</span><span class="p">(</span><span class="n">savedInstanceState</span><span class="p">:</span> <span class="n">Bundle</span><span class="p">?)</span> <span class="p">{</span>
    <span class="k">super</span><span class="p">.</span><span class="n">onCreate</span><span class="p">(</span><span class="n">savedInstanceState</span><span class="p">)</span>
    <span class="n">setContentView</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="n">layout</span><span class="p">.</span><span class="n">main_activity</span><span class="p">)</span>

    <span class="k">val</span> <span class="py">textView</span> <span class="p">=</span> <span class="n">findViewById</span><span class="p">&lt;</span><span class="n">View</span><span class="p">&gt;(</span><span class="n">R</span><span class="p">.</span><span class="n">id</span><span class="p">.</span><span class="n">helper_text</span><span class="p">)</span>

    <span class="k">val</span> <span class="py">app</span> <span class="p">=</span> <span class="n">application</span> <span class="k">as</span> <span class="n">ExampleApplication</span>
    <span class="c1">// What a Terrible Failure!</span>
    <span class="n">app</span><span class="p">.</span><span class="n">leakedViews</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">textView</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>Let&rsquo;s pretend that we don&rsquo;t know about this bad code. We just joined a new company that has an existing Android app, we set up LeakCanary, and soon enough tit produces a leak trace that looks like this:</p>
<div class="codehilite"><pre><span></span>‚î¨‚îÄ‚îÄ‚îÄ
‚îÇ GC Root: System class
‚îÇ
‚îú‚îÄ android.provider.FontsContract class
‚îÇ    ‚Üì static FontsContract.sContext
‚îú‚îÄ com.example.leakcanary.ExampleApplication instance
‚îÇ    ‚Üì ExampleApplication.leakedViews
‚îú‚îÄ java.util.ArrayList instance
‚îÇ    ‚Üì ArrayList.elementData
‚îú‚îÄ java.lang.Object[] array
‚îÇ    ‚Üì Object[].[0]
‚îú‚îÄ android.widget.TextView instance
‚îÇ    ‚Üì TextView.mContext
‚ï∞‚Üí com.example.leakcanary.MainActivity instance
</pre></div>

<p>In words: the <code>FontsContract</code> class is a system class and has an <code>sContext</code> static field which references the <code>ExampleApplication</code> instance which has a <code>leakedViews</code> field which references an array list which references an array (the array backing the array list implementation) which contains a <code>TextView</code> which has an <code>mContext</code> field which references a destroyed instance of <code>MainActivity</code>. Let&rsquo;s highlight all references we are currently suspecting of causing this leak:</p>
<div class="codehilite"><pre><span></span>‚î¨‚îÄ‚îÄ‚îÄ
‚îÇ GC Root: System class
‚îÇ
‚îú‚îÄ android.provider.FontsContract class
‚îÇ    ‚Üì static FontsContract.sContext
‚îÇ                           ~~~~~~~~
‚îú‚îÄ com.example.leakcanary.ExampleApplication instance
‚îÇ    Leaking: NO (Application is a singleton)
‚îÇ    ‚Üì ExampleApplication.leakedViews
‚îÇ                         ~~~~~~~~~~~
‚îú‚îÄ java.util.ArrayList instance
‚îÇ    ‚Üì ArrayList.elementData
‚îÇ                ~~~~~~~~~~~
‚îú‚îÄ java.lang.Object[] array
‚îÇ    ‚Üì Object[].[0]
‚îÇ               ~~~
‚îú‚îÄ android.widget.TextView instance
‚îÇ    ‚Üì TextView.mContext
‚îÇ               ~~~~~~~~
‚ï∞‚Üí com.example.leakcanary.MainActivity instance
</pre></div>

<p>Our next step is to <strong>reason about the state and lifecycle</strong> of the objects in the leak trace: we know that in an Android app the Application instance is a singleton that is never garbage collected, so it&rsquo;s never leaking. From that, we can conclude that the leak is not caused by <code>FontsContract.sContext</code>. Let&rsquo;s update our suspected references:</p>
<div class="codehilite"><pre><span></span>‚î¨‚îÄ‚îÄ‚îÄ
‚îÇ GC Root: System class
‚îÇ
‚îú‚îÄ android.provider.FontsContract class
‚îÇ    ‚Üì static FontsContract.sContext
‚îú‚îÄ com.example.leakcanary.ExampleApplication instance
‚îÇ    Leaking: NO (Application is a singleton)
‚îÇ    ‚Üì ExampleApplication.leakedViews
‚îÇ                         ~~~~~~~~~~~
‚îú‚îÄ java.util.ArrayList instance
‚îÇ    ‚Üì ArrayList.elementData
‚îÇ                ~~~~~~~~~~~
‚îú‚îÄ java.lang.Object[] array
‚îÇ    ‚Üì Object[].[0]
‚îÇ               ~~~
‚îú‚îÄ android.widget.TextView instance
‚îÇ    ‚Üì TextView.mContext
‚îÇ               ~~~~~~~~
‚ï∞‚Üí com.example.leakcanary.MainActivity instance
</pre></div>

<p>We also know that the <code>TexView</code> instance references our destroyed activity instance via it&rsquo;s <code>mContext</code> field. Views should not survive the lifecycle of their context, so we know that this text view is leaking:</p>
<div class="codehilite"><pre><span></span>‚î¨‚îÄ‚îÄ‚îÄ
‚îÇ GC Root: System class
‚îÇ
‚îú‚îÄ android.provider.FontsContract class
‚îÇ    ‚Üì static FontsContract.sContext
‚îú‚îÄ com.example.leakcanary.ExampleApplication instance
‚îÇ    Leaking: NO (Application is a singleton)
‚îÇ    ‚Üì ExampleApplication.leakedViews
‚îÇ                         ~~~~~~~~~~~
‚îú‚îÄ java.util.ArrayList instance
‚îÇ    ‚Üì ArrayList.elementData
‚îÇ                ~~~~~~~~~~~
‚îú‚îÄ java.lang.Object[] array
‚îÇ    ‚Üì Object[].[0]
‚îÇ               ~~~
‚îú‚îÄ android.widget.TextView instance
‚îÇ    Leaking: YES (View.mContext references a destroyed activity)
‚îÇ    ‚Üì TextView.mContext
‚ï∞‚Üí com.example.leakcanary.MainActivity instance
</pre></div>

<p>Reasoning about the state and lifecycle of the objects in the leak trace help us narrow down the list of suspect references. The good news here is that most of that reasoning is automated, e.g. LeakCanary already knows that the Application class is a singleton and that Views should not survive the lifecycle of their context and will narrow down the list of suspects references for you. You can help LeakCanary help you by providing additional <code>ObjectInspector</code> implementations, see <a href="../recipes/#identifying-leaking-objects-and-labeling-objects">Identifying leaking objects and labeling objects</a>.</p>
<h2 id="3-find-the-cause">3. Find the cause<a class="headerlink" href="#3-find-the-cause" title="Permanent link">&para;</a></h2>
<p>So far, our investigation has taught us that there are 3 suspect references in our leak trace: <code>ExampleApplication.leakedViews</code>, <code>ArrayList.elementData</code> and <code>Object[].[0]</code>:</p>
<div class="codehilite"><pre><span></span>‚î¨‚îÄ‚îÄ‚îÄ
‚îÇ GC Root: System class
‚îÇ
‚îú‚îÄ android.provider.FontsContract class
‚îÇ    ‚Üì static FontsContract.sContext
‚îú‚îÄ com.example.leakcanary.ExampleApplication instance
‚îÇ    Leaking: NO (Application is a singleton)
‚îÇ    ‚Üì ExampleApplication.leakedViews
‚îÇ                         ~~~~~~~~~~~
‚îú‚îÄ java.util.ArrayList instance
‚îÇ    ‚Üì ArrayList.elementData
‚îÇ                ~~~~~~~~~~~
‚îú‚îÄ java.lang.Object[] array
‚îÇ    ‚Üì Object[].[0]
‚îÇ               ~~~
‚îú‚îÄ android.widget.TextView instance
‚îÇ    Leaking: YES (View.mContext references a destroyed activity)
‚îÇ    ‚Üì TextView.mContext
‚ï∞‚Üí com.example.leakcanary.MainActivity instance
</pre></div>

<p><code>ArrayList.elementData</code> and <code>Object[].[0]</code> are implementation details of <code>ArrayList</code>, and it&rsquo;s unlikely that there&rsquo;s a bug in the <code>ArrayList</code> implementation instead, so we know the problem is somewhere else, ie the only remaining reference: <code>ExampleApplication.leakedViews</code>.</p>
<h2 id="4-fix-the-leak">4. Fix the leak<a class="headerlink" href="#4-fix-the-leak" title="Permanent link">&para;</a></h2>
<p>Once we&rsquo;ve found the reference that&rsquo;s causing the leak, we need to figure out what that reference is about, when it should have been cleared and why it hasn&rsquo;t been. Sometimes it&rsquo;s obvious, like in this example. Sometimes we lack enough information to figure it out. You could either <a href="../recipes/#identifying-leaking-objects-and-labeling-objects">add labels</a>, or explore the hprof directly (see <a href="faq.md/#how-can-i-dig-beyond-the-leak-trace">How can I dig beyond the leak trace?</a>).</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Memory leaks cannot be fixed by replacing strong references with weak references. It&rsquo;s a common solution when attempting to quickly address memory issues, however it never works. The bugs that were causing references to be kept longer than necessary are still there. On top of that, it creates more bugs as some objects will now be garbage collected sooner than they should. It also makes the code much harder to maintain.</p>
</div>
<p>What&rsquo;s next? Try the <a href="../recipes/">code recipes</a>!</p>
                
                  
                

              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../fundamentals-how-leakcanary-works/" title="How LeakCanary works" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                How LeakCanary works
              </span>
            </div>
          </a>
        
        
          <a href="../recipes/" title="Code recipes" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Code recipes
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; 2015 Square, Inc.
          </div>
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.808e90bb.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:".."}})</script>
      
    
  </body>
</html>